---
# This playbook contains all actions that will be run on "local" host.

# - debug:
#   msg: "docker info {{ github_pwd }}"
# - name: Check docker
#   command: echo $(docker info)

# sudo apt-get update
- name: Update apt packages
  apt:
    update_cache: yes
  tags:
    - system

- name: Import dependencies installation tasks
  include_tasks: 1_install-dependencies.yml
  tags:
    - instance-setup

- name: Import Docker installation tasks
  include_tasks: 2_install-docker.yml
  tags:
    - instance-setup

- name: Import tasks for cleaning up potential existing containers, images and folder
  include_tasks: 3_docker-cleanup.yml
  tags:
    - docker-cleanup

- name: Import Github repo download tasks
  include_tasks: 4_clone-repo.yml
  tags:
    - build

- name: Import Docker deployment tasks for build environment
  include_tasks: 5_build_deployment.yml
  tags:
    - build

- name: Import tasks to test web app is running
  include_tasks: 6_acceptance_tests.yml
  tags:
    - build

- name: Import tasks to push images to Dockerhub
  include_tasks: 7_publish_registry.yml
  tags:
    - dockerhub_push

- name: Import Docker deployment tasks for prod environment
  include_tasks: 8_prod_deployment.yml
  tags:
    - prod

# sudo apt-get autoclean
- name: Remove useless apt packages from the cache
  apt:
    autoclean: yes
  tags:
    - system
 
# sudo apt-get autoremove
- name: Remove dependencies that are no longer required
  apt:
    autoremove: yes
  tags:
    - system